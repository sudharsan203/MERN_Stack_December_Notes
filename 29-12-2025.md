# Class Notes: JWT, bcryptjs, Customer Routes & Admin Routes

## Table of Contents
1. [JWT (JSON Web Tokens)](#jwt-json-web-tokens)
2. [bcryptjs - Password Hashing](#bcryptjs-password-hashing)
3. [Customer Routes](#customer-routes)
4. [Admin Routes](#admin-routes)

---

## JWT (JSON Web Tokens)

### What is JWT?
JWT (JSON Web Token) is a secure way to transmit information between parties as a JSON object. It's primarily used for **authentication** and **authorization** in web applications.

### JWT Structure
A JWT consists of three parts separated by dots (`.`):
```
header.payload.signature
```

**Example:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIxMjM0NTYiLCJyb2xlIjoiY3VzdG9tZXIifQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

### How JWT Works in Our Project

#### 1. **Token Generation** (During Login/Registration)
Located in: [routes/auth.js](routes/auth.js#L7-L14)

```javascript
const generateToken = (userId, role) => {
  return jwt.sign(
    { userId, role },           // Payload: data to encode
    process.env.JWT_SECRET,     // Secret key for signing
    { expiresIn: '24h' }        // Token expires in 24 hours
  );
};
```

**What happens:**
- When a user logs in or registers, we create a token containing their `userId` and `role`
- The token is signed with a secret key (stored in `.env` file)
- Token expires after 24 hours for security

#### 2. **Token Verification** (For Protected Routes)
Located in: [middleware/auth.js](middleware/auth.js#L5-L50)

```javascript
const authenticateUser = async (req, res, next) => {
  // 1. Extract token from Authorization header
  const token = req.headers.authorization?.split(' ')[1]; // "Bearer <token>"
  
  if (!token) {
    return res.status(401).json({ error: 'No token provided' });
  }

  // 2. Verify the token
  const decoded = jwt.verify(token, process.env.JWT_SECRET);
  
  // 3. Check if user exists in database
  const user = await User.findById(decoded.userId);
  
  // 4. Attach user info to request object
  req.userId = decoded.userId;
  req.userRole = decoded.role;
  req.user = user;
  
  next(); // Proceed to the route handler
};
```

### JWT Authentication Flow
```
1. User Login → Server validates credentials
2. Server generates JWT token → Returns token to client
3. Client stores token (localStorage/cookies)
4. Client sends token with each request → Header: Authorization: Bearer <token>
5. Server verifies token → Grants/Denies access
```

### Error Handling
```javascript
// JsonWebTokenError: Invalid token format
// TokenExpiredError: Token has expired (after 24h)
```

---

## bcryptjs - Password Hashing

### Why Hash Passwords?
**Never store plain text passwords!** If a database is compromised, all passwords would be exposed. Hashing is a one-way encryption that protects user passwords.

### How bcryptjs Works

Located in: [models/User.js](models/User.js#L5-L16)

#### 1. **Hashing a Password** (During Registration)
```javascript
static async hashPassword(password) {
  const salt = await bcrypt.genSalt(10);  // Generate salt (random string)
  return await bcrypt.hash(password, salt); // Hash password with salt
}
```

**Example:**
```javascript
Input:  "myPassword123"
Salt:   "$2a$10$abcdefghijklmnopqrstuv"
Output: "$2a$10$abcdefghijklmnopqrstuv.HIYGFjk2l3n4o5p6q7r8s9t0u1v2w3x"
```

**Key Concepts:**
- **Salt**: A random string added to the password before hashing (prevents rainbow table attacks)
- **Salt Rounds (10)**: Number of times the hashing algorithm is applied (higher = more secure but slower)
- **One-Way**: You cannot reverse a hash back to the original password

#### 2. **Comparing Passwords** (During Login)
```javascript
static async comparePassword(password, hashedPassword) {
  return await bcrypt.compare(password, hashedPassword);
}
```

**What happens:**
```javascript
Input password: "myPassword123"
Stored hash: "$2a$10$abcdefghijklmnopqrstuv.HIYGFjk2l3n4o5p6q7r8s9t0u1v2w3x"

bcrypt.compare() → Extracts salt from hash → Hashes input with same salt → Compares results
Returns: true or false
```

### Password Security Flow in Our App

**Registration:**
```
1. User submits: { email: "user@example.com", password: "myPassword123" }
2. Server hashes password with bcrypt
3. Server stores: { email: "user@example.com", password: "$2a$10$hashed..." }
```

**Login:**
```
1. User submits: { email: "user@example.com", password: "myPassword123" }
2. Server finds user by email
3. Server compares submitted password with stored hash using bcrypt.compare()
4. If match → Generate JWT token
5. If no match → Return error "Invalid credentials"
```

---

## Customer Routes

Customer routes allow regular users to browse products, manage their cart, and place orders.

### Authentication Requirement
All customer routes use `authenticateUser` middleware - requires valid JWT token.

### 1. Mobiles Routes (`/api/mobiles`)
Located in: [routes/mobiles.js](routes/mobiles.js)

#### **GET /api/mobiles** - Browse All Mobiles
```javascript
Query Parameters:
- page: Page number (default: 1)
- limit: Items per page (default: 10)
- brand: Filter by brand (e.g., "Samsung")
- minPrice: Minimum price filter
- maxPrice: Maximum price filter
- search: Search in brand, model, description
- sort: Sort field (default: 'createdAt')
- order: Sort order 'asc' or 'desc' (default: 'desc')

Example Request:
GET /api/mobiles?brand=Samsung&minPrice=20000&maxPrice=50000&page=1&limit=10
Headers: Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": [...mobiles],
  "pagination": {
    "currentPage": 1,
    "totalPages": 5,
    "totalItems": 45
  }
}
```

#### **GET /api/mobiles/:id** - Get Single Mobile Details
```javascript
Example: GET /api/mobiles/507f1f77bcf86cd799439011
```

#### **GET /api/mobiles/filters/brands** - Get All Available Brands
```javascript
Response: { "success": true, "data": ["Samsung", "Apple", "OnePlus", ...] }
```

### 2. Cart Routes (`/api/cart`)
Located in: [routes/cart.js](routes/cart.js)

#### **GET /api/cart** - View Current Cart
```javascript
Headers: Authorization: Bearer <token>

Response:
{
  "success": true,
  "data": {
    "items": [
      {
        "mobile": { brand: "Samsung", model: "S21", price: 45000 },
        "quantity": 2,
        "subtotal": 90000
      }
    ],
    "total": 90000
  }
}
```

#### **POST /api/cart/add** - Add Item to Cart
```javascript
Body: { "mobileId": "507f1f77bcf86cd799439011", "quantity": 1 }
```

#### **PUT /api/cart/update** - Update Item Quantity
```javascript
Body: { "mobileId": "507f1f77bcf86cd799439011", "quantity": 3 }
```

#### **DELETE /api/cart/remove/:mobileId** - Remove Item
```javascript
DELETE /api/cart/remove/507f1f77bcf86cd799439011
```

#### **DELETE /api/cart/clear** - Clear Entire Cart
```javascript
DELETE /api/cart/clear
```

### 3. Orders Routes (`/api/orders`)
Located in: [routes/orders.js](routes/orders.js)

#### **POST /api/orders/place** - Place Order from Cart
```javascript
Body:
{
  "shippingAddress": "123 Main St, City, State 12345"
}

Process:
1. Validate cart is not empty
2. Check stock availability for all items
3. Create order with items from cart
4. Reduce stock in Mobile inventory
5. Clear user's cart
6. Return order confirmation

Response:
{
  "success": true,
  "message": "Order placed successfully",
  "data": { orderId, items, totalAmount, status: "pending" }
}
```

#### **GET /api/orders/my-orders** - View User's Order History
```javascript
Query: ?page=1&limit=10

Response: List of all orders by the logged-in user
```

#### **GET /api/orders/:id** - View Specific Order Details
```javascript
GET /api/orders/507f1f77bcf86cd799439011
```

### Customer Route Summary
| Route | Method | Purpose |
|-------|--------|---------|
| `/api/mobiles` | GET | Browse all mobiles with filters |
| `/api/mobiles/:id` | GET | Get mobile details |
| `/api/cart` | GET | View cart |
| `/api/cart/add` | POST | Add to cart |
| `/api/cart/update` | PUT | Update quantity |
| `/api/cart/remove/:id` | DELETE | Remove from cart |
| `/api/orders/place` | POST | Place order |
| `/api/orders/my-orders` | GET | View order history |

---

## Admin Routes

Admin routes provide full control over inventory, orders, and users. **Requires admin role.**

### Authentication Requirement
All admin routes use `authenticateAdmin` middleware:
- Verifies JWT token
- Checks if user role is 'admin'
- Returns 403 Forbidden if not admin

### 1. Admin Mobiles Routes (`/api/admin/mobiles`)
Located in: [routes/adminMobiles.js](routes/adminMobiles.js)

#### **GET /api/admin/mobiles** - View All Mobiles (Including Unavailable)
```javascript
Query: ?page=1&limit=10
Note: Unlike customer route, shows all mobiles regardless of availability
```

#### **POST /api/admin/mobiles/add** - Add New Mobile
```javascript
Body:
{
  "brand": "Samsung",
  "model": "Galaxy S23",
  "price": 65000,
  "description": "Latest flagship",
  "imageUrl": "https://...",
  "stock": 50,
  "isAvailable": true,
  "specifications": {
    "ram": "8GB",
    "storage": "128GB",
    "camera": "50MP"
  }
}

Response: Newly created mobile object
```

#### **PUT /api/admin/mobiles/update/:id** - Update Mobile Details
```javascript
PUT /api/admin/mobiles/update/507f1f77bcf86cd799439011

Body: { "price": 60000, "stock": 100 }
Note: Can update any field
```

#### **DELETE /api/admin/mobiles/delete/:id** - Delete Mobile
```javascript
DELETE /api/admin/mobiles/delete/507f1f77bcf86cd799439011
```

#### **PATCH /api/admin/mobiles/stock/:id** - Update Stock Only
```javascript
PATCH /api/admin/mobiles/stock/507f1f77bcf86cd799439011

Body: { "stock": 75 }
Use case: Quick stock updates without modifying other fields
```

### 2. Admin Orders Routes (`/api/admin/orders`)

#### **GET /api/admin/orders** - View All Orders
```javascript
Query: ?page=1&limit=10&status=pending

Filters by status: pending, processing, shipped, delivered, cancelled
```

#### **GET /api/admin/orders/:id** - View Order Details
```javascript
GET /api/admin/orders/507f1f77bcf86cd799439011
```

#### **PATCH /api/admin/orders/status/:id** - Update Order Status
```javascript
PATCH /api/admin/orders/status/507f1f77bcf86cd799439011

Body: { "status": "shipped" }

Workflow:
pending → processing → shipped → delivered
         ↘ cancelled (any time)
```

#### **GET /api/admin/orders/stats** - Order Statistics
```javascript
Response:
{
  "totalOrders": 234,
  "pendingOrders": 12,
  "totalRevenue": 1234567,
  "ordersByStatus": { "pending": 12, "shipped": 45, ... }
}
```

### 3. Admin Users Routes (`/api/admin/users`)

#### **GET /api/admin/users** - View All Users
```javascript
Query: ?page=1&limit=10&role=customer
```

#### **GET /api/admin/users/:id** - View User Details
```javascript
GET /api/admin/users/507f1f77bcf86cd799439011
```

#### **PATCH /api/admin/users/role/:id** - Change User Role
```javascript
PATCH /api/admin/users/role/507f1f77bcf86cd799439011

Body: { "role": "admin" }
Note: Upgrade customer to admin or vice versa
```

#### **DELETE /api/admin/users/:id** - Delete User
```javascript
DELETE /api/admin/users/507f1f77bcf86cd799439011
```

### Admin Route Summary
| Route | Method | Purpose |
|-------|--------|---------|
| `/api/admin/mobiles` | GET | View all mobiles |
| `/api/admin/mobiles/add` | POST | Add new mobile |
| `/api/admin/mobiles/update/:id` | PUT | Update mobile |
| `/api/admin/mobiles/delete/:id` | DELETE | Delete mobile |
| `/api/admin/mobiles/stock/:id` | PATCH | Update stock |
| `/api/admin/orders` | GET | View all orders |
| `/api/admin/orders/status/:id` | PATCH | Update order status |
| `/api/admin/users` | GET | View all users |
| `/api/admin/users/role/:id` | PATCH | Change user role |

---

## Authentication Middleware Comparison

### `authenticateUser` (Customer Routes)
```javascript
✓ Verifies JWT token
✓ Checks user exists
✓ Works for both customers and admins
✗ Does NOT check role
```

### `authenticateAdmin` (Admin Routes)
```javascript
✓ Verifies JWT token
✓ Checks user exists
✓ Checks user role === 'admin'
✗ Blocks customers (403 Forbidden)
```

---

## Security Best Practices in Our App

1. **Password Hashing**: All passwords hashed with bcrypt (10 rounds)
2. **JWT Tokens**: Expire after 24 hours
3. **Role-Based Access**: Separate middleware for customer vs admin
4. **Authorization Headers**: Tokens sent via `Authorization: Bearer <token>`
5. **Token Validation**: Every protected route verifies token
6. **Error Messages**: Generic errors to prevent information leakage
   - ❌ "Password incorrect" → ✅ "Invalid credentials"

---

## Complete Authentication Flow Example

### Registration Flow
```
1. POST /api/auth/register
   Body: { name, email, password }

2. User Model → bcrypt.hash(password)
   Store: { name, email, password: "$2a$10$hashed..." }

3. Generate JWT token
   Payload: { userId, role: "customer" }

4. Response: { user, token }
```

### Login Flow
```
1. POST /api/auth/login
   Body: { email, password }

2. Find user by email

3. bcrypt.compare(password, user.password)
   If false → 401 Unauthorized

4. Generate JWT token
   Payload: { userId, role }

5. Response: { user, token }
```

### Accessing Protected Route
```
1. GET /api/cart
   Headers: { Authorization: "Bearer eyJhbGc..." }

2. authenticateUser middleware
   - Extract token from header
   - jwt.verify(token, secret)
   - Find user in database
   - Attach req.userId, req.user

3. Route handler executes
   - Can access req.userId
   - Can access req.user

4. Response: User's cart data
```

---

## Testing with HTTP Files

### Test Customer Routes
```http
### Login as Customer
POST http://localhost:5000/api/auth/login
Content-Type: application/json

{
  "email": "customer@example.com",
  "password": "password123"
}

### Get Mobiles (use token from login)
GET http://localhost:5000/api/mobiles
Authorization: Bearer <your-token-here>
```

### Test Admin Routes
```http
### Login as Admin
POST http://localhost:5000/api/auth/login
Content-Type: application/json

{
  "email": "admin@example.com",
  "password": "admin123"
}

### Add Mobile (admin only)
POST http://localhost:5000/api/admin/mobiles/add
Authorization: Bearer <admin-token>
Content-Type: application/json

{
  "brand": "OnePlus",
  "model": "11 Pro",
  "price": 55000,
  "stock": 30
}
```

---

## Common Interview Questions

### Q1: What is the difference between authentication and authorization?
**Authentication**: Verifying who you are (login with email/password)
**Authorization**: Verifying what you can access (admin vs customer)

### Q2: Why use JWT instead of sessions?
- **Stateless**: Server doesn't need to store session data
- **Scalable**: Works across multiple servers
- **Mobile-friendly**: Easy to use with mobile apps

### Q3: Can you decode a JWT without the secret?
- **Yes**, you can decode the header and payload (they're base64 encoded)
- **No**, you cannot verify or modify it without the secret
- Never store sensitive data in JWT payload (it's not encrypted)

### Q4: What happens if JWT secret is compromised?
- Attacker can create fake tokens for any user
- All existing tokens should be invalidated
- Change secret and force all users to re-login

### Q5: Why salt passwords?
- Prevents rainbow table attacks
- Same password → different hash for each user
- Example: Two users with password "12345" have different hashes

---

## Summary Diagram

```
┌─────────────────────────────────────────────────────────┐
│                    CLIENT REQUEST                        │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
            ┌─────────────────────────┐
            │  Authorization Header   │
            │  Bearer <JWT Token>     │
            └─────────────────────────┘
                          │
                          ▼
            ┌─────────────────────────┐
            │   Middleware Checks     │
            │  - authenticateUser     │
            │  - authenticateAdmin    │
            └─────────────────────────┘
                          │
                ┌─────────┴─────────┐
                ▼                   ▼
          ┌──────────┐        ┌──────────┐
          │ Customer │        │  Admin   │
          │  Routes  │        │  Routes  │
          └──────────┘        └──────────┘
                │                   │
        ┌───────┼───────┐   ┌───────┼────────┐
        ▼       ▼       ▼   ▼       ▼        ▼
     Mobiles  Cart  Orders Users  Mobiles  Orders
```

---

**End of Class Notes**
